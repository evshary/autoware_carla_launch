# autoware_carla_launch

The package includes launch file to run Autoware, Carla agent, and bridge ([zenoh-bridge-dds](https://github.com/eclipse-zenoh/zenoh-plugin-dds) + [zenoh_carla_bridge](https://github.com/evshary/zenoh_carla_bridge)).

https://youtu.be/UFBRMqJ2r0w

# Prerequisites

Make sure you meet the following system requirements

* Ubuntu 20.04
* Autoware.universe galactic version
  - Only needed if you running in native host
* Carla 0.9.13

## Running in native host

* Install Autoware

## Running in docker

**Not stable currently**

```shell
sudo apt install docker.io python3-rocker
./run-docker.sh
```

# Build

* Clean the files

```shell
make clean
```

* Download necessary code & data

```shell
source env.sh
make prepare
```

* Build

```shell
# Source Autoware first before build
make build
```

# Usage

## Carla with Autoware

The section shows how to run Autoware in Carla simulator.

1. Run Carla simulator first

```shell
./CarlaUE4.sh -quality-level=Epic -world-port=2000 -RenderOffScreen
```

2. Run Autoware with Carla
 
```shell
source env.sh
ros2 launch autoware_carla_launch autoware_carla.launch.xml
```

3. (Option) The launch file above equals to the following two commands

```shell
## Running Carla Bridge and Python Agent
ros2 launch autoware_carla_launch carla_bridge.launch.xml
## Running zenoh-bridge-dds and Autoware
ros2 launch autoware_carla_launch autoware_zenoh.launch.xml
```

## Run multiple vehicles with Autoware in Carla at the same time

* Since running two Autoware will cause port conflict, we need to do some modification.
  - Modify `src/universe/autoware.universe/launch/tier4_planning_launch/launch/scenario_planning/lane_driving/behavior_planning/behavior_planning.launch.py` (About line 177) 

```diff
+ import random
....
            {
                "bt_tree_config_path": [
                    FindPackageShare("behavior_path_planner"),
                    "/config/behavior_path_planner_tree.xml",
                ],
+               "groot_zmq_publisher_port": random.randint(2000, 4000),
+               "groot_zmq_server_port": random.randint(2000, 4000),
                "planning_hz": 10.0,
            },
```

* Able to spawn second vehicle into Carla.
  - Modify `src/autoware_carla_launch/launch/carla_bridge.launch.xml` (About line 7)

```diff
-<executable cmd="poetry run python3 main.py --host $(env CARLA_SIMULATOR_IP) --sync --rolename $(env VEHICLE_NAME)" cwd="$(env AUTOWARE_CARLA_ROOT)/external/zenoh_carla_bridge/carla_agent" output="screen" />
+<executable cmd="poetry run python3 main.py --host $(env CARLA_SIMULATOR_IP) --sync --rolename $(env VEHICLE_NAME) --position 87.687683,145.671295,0.300000,0.000000,90.000053,0.000000" cwd="$(env AUTOWARE_CARLA_ROOT)/external/zenoh_carla_bridge/carla_agent" output="screen" />
+<executable cmd="poetry run python3 main.py --host $(env CARLA_SIMULATOR_IP) --rolename 'v2' --position 92.109985,227.220001,0.300000,0.000000,-90.000298,0.000000" cwd="$(env AUTOWARE_CARLA_ROOT)/external/zenoh_carla_bridge/carla_agent" output="screen" />
```

* Spawn vehicles into Carla
  - Run Carla
  - Run `ros2 launch autoware_carla_launch carla_bridge.launch.xml`

* Run Autoware twice:
  - 1st: `ROS_DOMAIN_ID=1 VEHICLE_NAME="v1" ros2 launch autoware_carla_launch autoware_zenoh.launch.xml`
  - 2nd: `ROS_DOMAIN_ID=2 VEHICLE_NAME="v2" ros2 launch autoware_carla_launch autoware_zenoh.launch.xml`

* Now there are two rviz with separated Autoware at the same time. You can control them separately!

## Manual control vehicle in Carla

The section shows how to control vehicles manually in Carla.

1. Run Carla simulator first

```shell
./CarlaUE4.sh -quality-level=Epic -world-port=2000 -RenderOffScreen
```

2. Run Autoware with Carla

```shell
source env.sh
ros2 launch autoware_carla_launch manual_control.launch.xml
```

3. Run manual control package

```shell
source env.sh
ros2 run autoware_manual_control keyboard_control
```

# FAQ

* [How to change the map](carla_map/README.md)

# Known Issues

* Upgrade Autoware: Porting the bridge to ROS 2 Humble.
* Generate the map: Now we're using the maps generated by Hatem.
* Running with docker container is really lag...
